---
description: カスタムフック実装ルール
globs: hooks/**/*.ts
alwaysApply: false
---

# 役割
- クライアント状態・購読・副作用をまとめ、UIに必要なデータとハンドラを渡す。  
- Firestore/Storage/Auth とのやり取りはここで受け、コンポーネントは表示に専念。

# 実装規則
- Firestore への実アクセスは `lib/firestore.ts` 経由。フック内で SDK を直接生成しない。  
- 複数書き込みは直列化/トランザクションを考慮し、`saveUserData` 等の集約APIを利用。  
- `useEffect` のクリーンアップを必ず実装し、購読解除漏れを防ぐ。  
- 端末時計禁止。`serverTimestamp()` 由来の値や保存済み文字列を使用。  
- フックは UI を含めず、返却値は明確な型を付与する。

# アンチパターン
- フック内で DOM 操作やスタイル操作を行うこと。  
- `any` での型回避、未処理の Promise 例外放置。  
- Firestore 更新前にローカル state を確定させる楽観的更新。

# 実装例
- 全体データ購読/書き込み: [`hooks/useAppData.ts`](../../../hooks/useAppData.ts)  
- 通知管理と localStorage 移行: [`hooks/useNotifications.ts`](../../../hooks/useNotifications.ts)  
- 認証購読: [`lib/auth.ts`](../../../lib/auth.ts) （hook利用箇所の参考）

