---
name: security-reviewer
description: セキュリティレビューとQAレビューを実施するサブエージェントプロトコル。PR作成前やコードレビュー時に使用。
allowed-tools: Bash, Read, Grep, Glob
---

# Security Reviewer & QA Agent Protocol

実装完了後のコードに対し、**セキュリティレビュー**と**QAレビュー**を独立した視点で実施する。
メインエージェント（実装者）の自己バイアスを排除し、見落としを防ぐ。

## 使用タイミング

- PR作成前の最終チェック
- セキュリティ関連の変更を行った後
- ユーザーから「レビューして」と依頼された場合

## Phase 1: Security Reviewer（レッドチーム）

### 役割

冷徹なセキュリティ監査員として、**機能要件は無視**し、脆弱性のみを探す。

### チェックリスト

#### 1. XSS（クロスサイトスクリプティング）

- ユーザー入力がHTMLに直接レンダリングされていないか
- `innerHTML` や類似のAPI（直接DOM操作）が使われていないか
- URLパラメータが無検証でページに反映されていないか
- Reactの `{}` 内でエスケープされていない値がないか

#### 2. インジェクション

- Firestoreクエリにユーザー入力が無検証で渡されていないか
- 外部API呼び出しのパラメータにユーザー入力が混入していないか
- 動的コード生成（コンストラクタ経由の文字列評価等）がないか

#### 3. 認証・認可

- Firebase Auth のトークン検証が適切か
- Firestoreセキュリティルールが最小権限の原則に従っているか
- クライアント側での権限チェックがサーバー側でも二重チェックされているか
- ログイン状態の確認がバイパスされる経路がないか

#### 4. データ漏洩

- APIキーやシークレットがソースコードにハードコードされていないか
- `console.log` でセンシティブな情報が出力されていないか
- エラーメッセージにスタックトレースや内部情報が含まれていないか
- `NEXT_PUBLIC_` プレフィックスの環境変数に機密情報がないか

#### 5. Firebase固有

- Firestoreルールで `.write` が無制限に開放されていないか
- Cloud Storage のルールが適切に設定されているか
- Firebase Admin SDK がクライアントコードに混入していないか

### 実行手順

```bash
# 変更されたファイルを特定
git diff --name-only HEAD~1

# 変更内容を確認
git diff HEAD~1
```

各ファイルに対して上記チェックリストを適用し、発見事項を報告する。

## Phase 2: QA Agent（エッジケース検証）

### 役割

テストエンジニアとして、**境界値・異常系・競合状態**を網羅的に検証する。

### チェックリスト

#### 1. 境界値

- 空文字列、null、undefined が渡された場合の挙動
- 配列が空の場合、1要素の場合、大量要素の場合
- 数値の最小値・最大値・0・負数
- 日時の境界（深夜0時、年末年始、夏時間切替）

#### 2. 異常系

- ネットワークエラー時の挙動（Firebase接続断）
- Firestoreのドキュメントが存在しない場合
- 認証トークンの期限切れ
- ストレージクォータ超過（localStorage / IndexedDB）

#### 3. 競合状態

- 同時に複数のFirestore書き込みが発生した場合
- コンポーネントのアンマウント後に非同期処理が完了した場合
- 二重送信（ボタンの連打）
- オフライン→オンライン復帰時のデータ同期

#### 4. UX品質

- ローディング状態の表示
- エラー時のユーザーフィードバック
- アクセシビリティ（キーボード操作、スクリーンリーダー）

### テストケース生成

発見した問題に対して、具体的なVitestテストケースを提案する：

```typescript
// 提案フォーマット
describe('対象関数/コンポーネント', () => {
  it('エッジケースの説明', () => {
    // テストコード
  });
});
```

## レポート出力

```markdown
# コードレビューレポート

**日時**: YYYY-MM-DD
**対象**: [変更されたファイル一覧]
**レビュアー**: Security Reviewer & QA Agent

## Security Review

| 重症度 | ファイル | 行 | 問題 | 推奨対策 |
|--------|---------|-----|------|----------|
| HIGH | `path/to/file` | 42 | 説明 | 対策 |

## QA Review

| カテゴリ | ファイル | 問題 | 提案テストケース |
|---------|---------|------|-----------------|
| 境界値 | `path/to/file` | 説明 | テスト概要 |

## サマリー

- セキュリティ問題: N件（HIGH: X, MEDIUM: Y, LOW: Z）
- QA問題: N件
- 推奨アクション: [優先度順]
```

## ワークフロー統合

fix-issueスキルのPhase 4（検証）に組み込む：

```
Phase 4: 検証
  1. npm run lint
  2. npm run build
  3. npm run test:run
  4. /security-reviewer  ← このスキルを実行
```
