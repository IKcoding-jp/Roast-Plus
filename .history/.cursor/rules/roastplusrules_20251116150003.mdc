---
alwaysApply: true
---
# RoastPlus プロジェクト固有ルール

## プロジェクト概要
RoastPlusは、コーヒー豆加工業務をサポートするためのWebアプリです。チーム、メンバー、タスクラベルの管理と、それらの割り当て機能、またスケジュール管理や、試飲感想記録、欠点豆図鑑、作業進捗管理、ローストタイマー機能を提供します。

## 運用環境
- **デバイス構成**: 1つのアカウントを9台のデバイスで運用（iPad 1台、スマートフォン 8台）
- **マルチデバイス対応**: 同一アカウントで複数デバイスから同時アクセス可能
- **リアルタイム同期**: Firestoreの`onSnapshot`により、全デバイス間でデータがリアルタイムに同期
- **PWA対応**: Service WorkerとWeb App Manifestにより、ホーム画面に追加可能なPWAとして動作
- **オフライン対応**: Service Workerにより、オフライン時も基本的な機能が利用可能

## 技術スタック
- **フレームワーク**: Next.js 16.0.1
- **UIライブラリ**: React 19.2.0
- **言語**: TypeScript 5
- **スタイリング**: Tailwind CSS 4
- **バックエンド**: Firebase (Authentication + Firestore + Storage)
- **ビルド**: 本番環境では静的エクスポート (`output: 'export'`)
- **設定ファイル**: `next.config.ts`（TypeScript形式）
- **アイコンライブラリ**: react-icons, phosphor-react
- **バージョン**: 0.2.4

## アーキテクチャの原則

### データ管理
- Firestoreを使用してユーザーごとのデータを分離管理
- データ構造は `AppData` 型で定義（`types/index.ts`）
- 各ユーザーのデータは `/users/{userId}` パスに保存
- Firestoreセキュリティルールで、ユーザーは自分のデータのみアクセス可能
- **欠点豆マスターデータ**: `/defectBeans` コレクションに全ユーザー共通のマスターデータを保存
- **書き込み最適化**: マルチデバイス対応のため、書き込みキュー、デバウンス、セマフォ制御を実装

### ファイル構造
- `app/`: Next.js App Routerのページコンポーネント（ルートディレクトリ）
- `components/`: 再利用可能なReactコンポーネント（ルートディレクトリ）
- `hooks/`: カスタムフック
  - `useAppData.ts`: Firestoreデータの取得とリアルタイム更新
  - `useNotifications.ts`: 通知機能
  - `useDeveloperMode.ts`: 開発者モード機能
  - `useDefectBeans.ts`: 欠点豆データの管理（マスター+ユーザー追加）
  - `useDefectBeanSettings.ts`: 欠点豆設定（省く/省かない）の管理
  - `useRoastTimer.ts`: ローストタイマー機能
  - `useToast.ts`: トースト通知機能
  - `useAppVersion.ts`: アプリバージョン管理
  - `useAppLifecycle.ts`: アプリライフサイクル管理
- `lib/`: ユーティリティ関数とFirebase設定
  - `firebase.ts`: Firebase初期化
  - `firestore.ts`: Firestore操作（データCRUD、欠点豆マスター、作業進捗など）
  - `auth.ts`: Firebase認証（`useAuth`フック）
  - `storage.ts`: Firebase Storage操作（画像アップロードなど）
  - `roastTimerUtils.ts`: ローストタイマー関連ユーティリティ
  - `roastTimerSettings.ts`: ローストタイマー設定管理
  - `roastTimerRecords.ts`: ローストタイマー記録管理
  - `tastingUtils.ts`: 試飲関連ユーティリティ
  - `taskLabels.ts`: タスクラベル関連ユーティリティ
  - `notifications.ts`: 通知関連ユーティリティ
  - `versionManager.ts`: バージョン管理
  - `localStorage.ts`: ローカルストレージ操作
  - `sounds.ts`: 音声ファイル管理
  - `beanConfig.ts`: 豆設定
- `types/`: TypeScript型定義（`index.ts`）

### 認証とセキュリティ
- Firebase Authenticationを使用
- 環境変数でFirebase設定を管理（`NEXT_PUBLIC_FIREBASE_*`）
- Firestoreセキュリティルールで認証チェックを実施
- ユーザーIDは `request.auth.uid` で取得
- Firebase Storageルールで画像アップロードを制限

## コーディング規約

### TypeScript
- 型定義は `types/index.ts` に集約
- 既存の型定義を尊重し、一貫性を保つ
- `any` の使用を避け、適切な型を定義

### React/Next.js
- Server Componentsを優先し、必要に応じてClient Componentsを使用
- カスタムフックでロジックを分離
- コンポーネントは小さく、単一責任の原則に従う
- ページコンポーネントは `app/` ディレクトリに配置

### スタイリング
- Tailwind CSS 4を使用
- インラインクラスでスタイルを記述
- 再利用可能なスタイルはコンポーネント化を検討
- **レスポンシブデザイン**: iPadとスマートフォンの両方で快適に使用できるよう、画面サイズに応じたレイアウトを実装
- **タッチ操作最適化**: ボタンやインタラクティブ要素は、タッチ操作に適したサイズ（最小44x44px）を確保

### Firebase操作
- Firestore操作は `lib/firestore.ts` に集約
- Firebase設定は `lib/firebase.ts` で管理
- 認証関連は `lib/auth.ts` で管理
- Storage操作は `lib/storage.ts` で管理
- エラーハンドリングを適切に実装
- リアルタイム更新には `onSnapshot` を使用
- **マルチデバイス同期**: 複数デバイス間でのデータ競合を避けるため、Firestoreのトランザクションやサーバータイムスタンプを活用
- **書き込み最適化**: 書き込みキュー、デバウンス（300ms）、セマフォ制御（最大同時実行数3）により、9台のデバイスからの同時アクセスに対応

## データモデル

### 主要な型
- `Team`: チーム情報
- `Member`: メンバー情報（`teamId`で所属チームを参照、`excludedTaskLabelIds`で除外ラベルを管理）
- `Manager`: 管理者情報
- `TaskLabel`: タスクラベル（`leftLabel`と`rightLabel`でペアを表現）
- `TaskLabelSnapshot`: 作業ラベルの日付別スナップショット
- `Assignment`: 現在の割り当て（`memberId`が`null`の場合は未割り当て）
- `TimeLabel`: 時間ラベル（本日のスケジュール用）
- `TodaySchedule`: 本日のスケジュール（日次スケジュール、`TimeLabel`の配列を含む）
- `RoastSchedule`: ローストスケジュール（焙煎機予熱、ロースト、アフターパージ、チャフのお掃除など）
- `TastingSession`: 試飲セッション（豆の名前、焙煎度合い、メモなど）
- `TastingRecord`: 試飲記録（評価項目：苦味、酸味、ボディ、甘み、香り、総合評価など）
- `Notification`: 通知（`update`、`announcement`、`improvement`、`request`、`bugfix`タイプ）
- `DefectBean`: 欠点豆（マスターデータとユーザー追加データの両方に対応、`isMaster`フラグで区別）
- `DefectBeanSettings`: 欠点豆設定（省く/省かないの設定を欠点豆IDごとに管理）
- `WorkProgress`: 作業進捗（進捗状態、目標量、現在の進捗量、完成数、進捗履歴など）
- `ProgressEntry`: 進捗記録エントリ（日付、進捗量、メモ）
- `RoastTimerSettings`: ローストタイマー設定（タイマー音、通知音の設定など）
- `RoastTimerRecord`: ローストタイマー記録（実際のロースト時間を記録）
- `RoastTimerState`: ローストタイマー状態（実行中、一時停止、完了など）
- `UserSettings`: ユーザー設定（選択中のメンバーID、管理者ID、ローストタイマー設定など）
- `ShuffleEvent`: シャッフルイベント（マルチデバイス同期用）

### データ操作の原則
- データの追加・更新・削除は不変性を保つ（スプレッド演算子を使用）
- 削除時は関連データも適切に処理（例: チーム削除時はメンバーと割り当ても削除）
- データ操作関数は `lib/firestore.ts` に定義
- 欠点豆マスターデータは `/defectBeans` コレクションに保存（全ユーザー共通）
- ユーザー追加欠点豆は `AppData.defectBeans` に保存（ユーザーごと）
- 欠点豆設定は `AppData.defectBeanSettings` に保存（ユーザーごと）

## 主要機能

### 欠点豆図鑑
- マスターデータとユーザー追加データの両方を表示
- 検索機能（名称、特徴、味への影響、省く理由で検索）
- フィルタ機能（全て、省く設定、省かない設定）
- 比較機能（複数の欠点豆を選択して比較表示）
- 画像アップロード機能（Firebase Storageを使用）
- 省く/省かない設定の管理

### 作業進捗管理
- 作業進捗の作成、更新、削除
- 進捗状態の管理（pending、in_progress、completed）
- 目標量と現在の進捗量の管理
- 完成数の管理（目標量がない場合も記録可能）
- 進捗履歴の記録（日付、進捗量、メモ）
- グループ化機能（groupNameでグループ化）

### ローストタイマー
- タイマーの開始、一時停止、再開、リセット
- タイマー音と通知音の設定
- ロースト記録の保存（豆の名前、重さ、焙煎度合い、実際のロースト時間）
- マルチデバイス同期（複数デバイス間でタイマー状態を同期）
- 通知機能（タイマー完了時の通知）

### 試飲記録
- 試飲セッションの作成、編集、削除
- 試飲記録の作成、編集、削除
- 評価項目（苦味、酸味、ボディ、甘み、香り、総合評価）の記録（1.0〜5.0、0.125刻み）
- レーダーチャート表示
- セッションごとの記録一覧表示

## ビルドとデプロイ

### 開発環境
- `npm run dev` で開発サーバー起動（ポート3000）
- 通常のNext.js開発モードを使用

### 本番環境
- `npm run build` で静的エクスポートを生成
- **静的エクスポートの有効化**: `next.config.ts` で本番環境（`NODE_ENV === 'production'`）でのみ `output: 'export'` が有効化される
- 開発環境では通常のNext.jsサーバーとして動作（動的ルートが正常に動作する）
- 画像は `unoptimized: true` で最適化を無効化（静的エクスポートの制約）
- ビルド出力は `out/` ディレクトリに生成される
- アプリバージョンは `package.json` から自動取得（`NEXT_PUBLIC_APP_VERSION` 環境変数として設定）

### Firebase Hosting
- **デプロイ先**: Firebase Hosting
- **設定ファイル**: `firebase.json` の `hosting` セクションで設定
- **公開ディレクトリ**: `out/`（Next.jsの静的エクスポート出力先）
- **SPAルーティング**: `rewrites` で全てのリクエストを `/index.html` にリダイレクト
- **デプロイコマンド**: `firebase deploy --only hosting`（プロジェクトルートから実行）
- **webmanifest**: `.webmanifest` ファイルに適切なContent-Typeヘッダーを設定
- **キャッシュ設定**: HTMLファイルはキャッシュ無効化、静的アセット（JS/CSS/画像など）は長期キャッシュ（max-age=31536000, immutable）
- **フォントファイル**: woff2、woff、ttfファイルに適切なContent-Typeヘッダーを設定

## エラーハンドリング

### Firebase操作
- Firestore操作のエラーは適切にキャッチし、ログに記録
- エラー時はデフォルトデータを返すか、ユーザーに通知
- 書き込みエラー時はリトライ機構を実装（最大3回、指数バックオフ）

### データ検証
- データ読み込み時の型チェックを実施
- 存在しないデータの場合はデフォルトデータを返す

## パフォーマンス

### Firestore
- リアルタイムリスナーは適切にクリーンアップ（`Unsubscribe`を返す）
- 不要なリスナーは解除してメモリリークを防止
- **マルチデバイス最適化**: 9台のデバイスが同時に接続することを考慮し、不要なリスナーを避ける
- **書き込み最適化**: 書き込みキュー、デバウンス（300ms）、セマフォ制御（最大同時実行数3）により、Write stream exhaustedエラーを防止
- **オフライン対応**: Service Workerにより、ネットワーク接続が不安定な環境でも動作

### React
- 不要な再レンダリングを避ける
- カスタムフックで状態管理を最適化
- `useMemo`、`useCallback`を適切に使用
- **モバイルパフォーマンス**: スマートフォンのリソース制約を考慮し、軽量な実装を心がける

### PWA機能
- Service Workerは本番環境でのみ有効化（`process.env.NODE_ENV === 'production'`）
- Web App Manifest（`site.webmanifest`）でPWA設定を管理
- オフライン時の動作を考慮した実装

## セキュリティ

### 環境変数
- Firebase設定は環境変数で管理（`.env.local`に配置）
- `NEXT_PUBLIC_` プレフィックスはクライアント側で公開されるため注意

### Firestoreルール
- `firestore.rules` でユーザーごとのデータアクセスを制限
- 認証済みユーザーのみが自分のデータにアクセス可能
- 欠点豆マスターデータは全ユーザーが読み取り可能

### Storageルール
- `storage.rules` で画像アップロードを制限
- 認証済みユーザーのみが自分の画像をアップロード可能

## 開発時の注意事項

### 新機能追加時
- 既存のデータ構造との互換性を考慮
- 型定義を更新し、既存コードとの整合性を保つ
- Firestoreセキュリティルールの更新が必要な場合は確認
- Storageルールの更新が必要な場合は確認
- **マルチデバイス対応**: 新機能は複数デバイス間での動作を確認
- **レスポンシブデザイン**: iPadとスマートフォンの両方で適切に表示されることを確認
- **タッチ操作**: モバイルデバイスでの操作性を考慮したUI設計
- **書き込み最適化**: 頻繁な書き込みが発生する機能は、デバウンスやキューイングを検討

### リファクタリング時
- `lib/firestore.ts` の関数インターフェースを維持（既存コードとの互換性）
- データ操作の不変性を保つ
- テストを追加または更新

### 欠点豆機能の開発
- マスターデータとユーザー追加データを区別（`isMaster`フラグ）
- マスターデータは `/defectBeans` コレクションに保存
- ユーザー追加データは `AppData.defectBeans` に保存
- 画像は Firebase Storage に保存（`defect-beans/{userId}/{defectBeanId}` パス）
- 欠点豆設定は `AppData.defectBeanSettings` に保存

### 作業進捗機能の開発
- 進捗状態の自動変更ロジックを理解（pending → in_progress → completed）
- 目標量と現在の進捗量の管理
- 完成数の管理（目標量がない場合も記録可能）
- 進捗履歴の記録（`ProgressEntry`）

### ローストタイマー機能の開発
- マルチデバイス同期を考慮（`RoastTimerState`の`triggeredByDeviceId`、`completedByDeviceId`）
- タイマー音と通知音の設定（`RoastTimerSettings`）
- ロースト記録の保存（`RoastTimerRecord`）

## その他

### 依存関係
- 新規ライブラリ追加時は、プロジェクトの制約を確認
- 静的エクスポートとの互換性を考慮

### コメントとドキュメント
- 複雑なロジックにはコメントを追加
- 関数の目的とパラメータを明確に記述
- マルチデバイス同期の仕組みをコメントで説明

### バージョン管理
- アプリバージョンは `package.json` の `version` フィールドで管理
- バージョン更新時は `useAppVersion` フックで通知を表示
- バージョン更新通知は `VersionUpdateModal` コンポーネントで表示
