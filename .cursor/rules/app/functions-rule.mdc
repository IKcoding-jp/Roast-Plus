---
description: Firebase Functions実装ルール
globs: functions/**/*.ts
alwaysApply: false
---

# 役割
- クライアントから切り離されたサーバーサイド処理（OCR・集計など）を提供。  
- 認証・入力検証・外部API連携を安全に実行し、型付きレスポンスを返す。

# 実装規則
- TypeScriptで記述し、`HttpsError` 等で明示的にエラー種別を返す。  
- Secrets/APIキーは環境シークレットで管理し、ハードコード禁止。  
- 入力バリデーションとサイズ制限を必ず行う（例: 画像Base64長）。  
- ログは構造化して出力し、再現性のために`timestamp`と`tag`を付与。  
- 共通型は可能な限り `functions/src/types` または `types/index.ts` と整合を取る（乖離を作らない）。

# アンチパターン
- 例外を握り潰して汎用500を返すこと。  
- 無制限の外部API呼び出し、タイムアウト未設定。  
- クライアントで使用する秘密情報をレスポンスに含めること。

# 実装例
- Vision+OpenAI OCR Callable: [`functions/src/index.ts`](../../../functions/src/index.ts)  
- 共有型参照: [`functions/src/types.ts`](../../../functions/src/types.ts)
