---
alwaysApply: true
---

# アーキテクチャ

## プロジェクト概要

RoastPlusは、コーヒー豆加工業務をサポートするためのWebアプリです。チーム、メンバー、タスクラベルの管理と、それらの割り当て機能、またスケジュール管理や、試飲感想記録、欠点豆図鑑、作業進捗管理、ローストタイマー機能を提供します。

## 運用環境

- **デバイス構成**: 1つのアカウントを9台のデバイスで運用（iPad 1台、スマートフォン 8台）
- **マルチデバイス対応**: 同一アカウントで複数デバイスから同時アクセス可能
- **リアルタイム同期**: Firestoreの`onSnapshot`により、全デバイス間でデータがリアルタイムに同期
- **PWA対応**: Service WorkerとWeb App Manifestにより、ホーム画面に追加可能なPWAとして動作
- **オフライン対応**: Service Workerにより、オフライン時も基本的な機能が利用可能

## 技術スタック

- **フレームワーク**: Next.js 16.0.1
- **UIライブラリ**: React 19.2.0
- **言語**: TypeScript 5
- **スタイリング**: Tailwind CSS 4
- **バックエンド**: Firebase (Authentication + Firestore + Storage)
- **ビルド**: 本番環境では静的エクスポート (`output: 'export'`)
- **設定ファイル**: `next.config.ts`（TypeScript形式）
- **アイコンライブラリ**: react-icons, phosphor-react
- **バージョン**: 0.2.4

## ディレクトリ構造

### `app/`
Next.js App Routerのページコンポーネント（ルートディレクトリ）

### `components/`
再利用可能なReactコンポーネント（ルートディレクトリ）

### `hooks/`
カスタムフック

- `useAppData.ts`: Firestoreデータの取得とリアルタイム更新
- `useNotifications.ts`: 通知機能
- `useDeveloperMode.ts`: 開発者モード機能
- `useDefectBeans.ts`: 欠点豆データの管理（マスター+ユーザー追加）
- `useDefectBeanSettings.ts`: 欠点豆設定（省く/省かない）の管理
- `useRoastTimer.ts`: ローストタイマー機能
- `useToast.ts`: トースト通知機能
- `useAppVersion.ts`: アプリバージョン管理
- `useAppLifecycle.ts`: アプリライフサイクル管理

### `lib/`
ユーティリティ関数とFirebase設定

- `firebase.ts`: Firebase初期化
- `firestore.ts`: Firestore操作（データCRUD、欠点豆マスター、作業進捗など）
- `auth.ts`: Firebase認証（`useAuth`フック）
- `storage.ts`: Firebase Storage操作（画像アップロードなど）
- `roastTimerUtils.ts`: ローストタイマー関連ユーティリティ
- `roastTimerSettings.ts`: ローストタイマー設定管理
- `roastTimerRecords.ts`: ローストタイマー記録管理
- `tastingUtils.ts`: 試飲関連ユーティリティ
- `taskLabels.ts`: タスクラベル関連ユーティリティ
- `notifications.ts`: 通知関連ユーティリティ
- `versionManager.ts`: バージョン管理
- `localStorage.ts`: ローカルストレージ操作
- `sounds.ts`: 音声ファイル管理
- `beanConfig.ts`: 豆設定

### `types/`
TypeScript型定義（`index.ts`）

## アーキテクチャの原則

### データ管理
- Firestoreを使用してユーザーごとのデータを分離管理
- データ構造は `AppData` 型で定義（`types/index.ts`）
- 各ユーザーのデータは `/users/{userId}` パスに保存
- Firestoreセキュリティルールで、ユーザーは自分のデータのみアクセス可能
- **欠点豆マスターデータ**: `/defectBeans` コレクションに全ユーザー共通のマスターデータを保存
- **書き込み最適化**: マルチデバイス対応のため、書き込みキュー、デバウンス、セマフォ制御を実装

### 認証とセキュリティ
- Firebase Authenticationを使用
- 環境変数でFirebase設定を管理（`NEXT_PUBLIC_FIREBASE_*`）
- Firestoreセキュリティルールで認証チェックを実施
- ユーザーIDは `request.auth.uid` で取得
- Firebase Storageルールで画像アップロードを制限

## App Router

- Next.js 16 の App Router を使用
- Server Componentsを優先し、必要に応じてClient Componentsを使用
- ページコンポーネントは `app/` ディレクトリに配置

## PWA（Progressive Web App）

- Service WorkerとWeb App Manifestにより、ホーム画面に追加可能なPWAとして動作
- Service Workerは本番環境でのみ有効化（`process.env.NODE_ENV === 'production'`）
- Web App Manifest（`site.webmanifest`）でPWA設定を管理
- オフライン時の動作を考慮した実装

## オフライン対応

- Service Workerにより、オフライン時も基本的な機能が利用可能
- Firestoreのオフラインキャッシュを活用
- ネットワーク接続が不安定な環境でも動作

## レスポンシブデザイン

- iPadとスマートフォンの両方で快適に使用できるよう、画面サイズに応じたレイアウトを実装
- タッチ操作最適化: ボタンやインタラクティブ要素は、タッチ操作に適したサイズ（最小44x44px）を確保
