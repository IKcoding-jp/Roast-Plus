---
description: lib配下（Firebase・ユーティリティ）の実装ルール
globs: lib/**/*.ts
alwaysApply: false
---

# 役割
- Firebase 初期化・Firestore 読み書き・共通ユーティリティを集約する副作用レイヤ。  
- React 非依存で設計し、テストしやすい純粋関数を優先。

# 実装規則
- Firestore I/O はここに集約し、`components/`や`hooks/`から直接 SDK を呼ばない。  
- 書き込みは一操作一回。複数フィールド更新は `runTransaction` もしくは直列キューで扱う。  
- `serverTimestamp()` を利用し端末時計を排除。  
- データ保存前に `undefined` を除去し、型整合性を保つ（例: `removeUndefinedFields`）。  
- SDK インスタンスはシングルトン化し、重複初期化を避ける。

# アンチパターン
- `any` を介した Firestore 書き込み、スキーマを崩すフィールド追加。  
- setTimeout で段階的に永続化すること。  
- UI ロジックや DOM 依存コードを混在させること。

# 実装例
- Firebase 初期化: [`lib/firebase.ts`](../../../lib/firebase.ts)  
- Firestore 集約/直列書き込みキュー: [`lib/firestore.ts`](../../../lib/firestore.ts)  
- 認証ヘルパー: [`lib/auth.ts`](../../../lib/auth.ts)

