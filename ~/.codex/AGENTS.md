# RoastPlus Vibecoding Rules

バイブコーディング前提：依頼者は要件と優先度だけ伝える。設計・実装・修正・ドキュメント・テストは AI が責任を持って行い、結果を日本語・箇条書きで報告する。

## 1. 目的と前提
- プロダクト: RoastPlus（コーヒー焙煎業務支援 Web アプリ）
- 技術スタック: Next.js 16 (App Router, Server Components 前提) / React 19 / TypeScript 5 / Tailwind CSS 4 / Firebase (Auth + Firestore + Storage) / 静的エクスポート本番運用
- 運用: 1 アカウントを最大 9 台（iPad 1 + スマホ 8）で同時利用、マルチデバイス整合性が最優先
- データ: ユーザー固有データは `/users/{userId}`、欠陥豆マスタは `/defectBeans`、主要型は `types/index.ts` の `AppData`

## 2. バイブコーディング開発フロー
1) 依頼内容: ゴール/制約/優先度/締切を確認し、曖昧点は先に質問して解消する（推測で実装しない）  
2) プラン提示: 小さなステップ（3〜5 手順程度）で実行計画を提示。触るファイル・影響範囲・整合性/パフォーマンス/UX リスクを明記  
3) 方針合意: 必要なら「最小修正」と「推奨案」の 2 案を提示して合意を得る  
4) 実装: ステップごとに小さく変更。Firestore 整合性を崩さないよう都度確認  
5) 検証: 最低限の確認手順を提示（typecheck/lint/動作確認・テスト案）  
6) 報告: 変更概要、解消したリスク、未確認事項、次の一手を箇条書きで共有

## 3. 役割分担
- AI: 設計/実装/リファクタ/バグ修正/テスト提案/ドキュメント整備まで全担当。コードは必ず AI が生成し、依頼者にコードを書くよう求めてはならない。
- 依頼者: 要件・優先度・制約・承認のみを行う。手動コーディングや部分実装の依頼は不要。

## 4. リファクタ・バグ修正標準プロセス
1) 対象ファイルと現状挙動を短く要約  
2) 問題点と影響範囲（特に Firestore 整合性・マルチデバイス・PWA）を箇条書き  
3) 方針提示: 最小修正 / 推奨設計のいずれか、または両方  
4) 小さな変更を実施し、挙動を変えないことを原則（変更する場合は理由とリスクを明記）  
5) 変更点を説明し、想定確認手順（簡易チェック or テスト案）を提示

## 5. Next.js / TypeScript / Firestore 基本原則
- Firestore を Single Source of Truth とする。UI 更新フローは「Firestore → onSnapshot → state → UI」。楽観的更新やローカル state での先行上書きは禁止。
- 時刻・日付は端末時計を使わず、Firestore 保存値または `serverTimestamp()` を利用。
- 一操作一書き込みが原則。段階的な setTimeout 書き込みは禁止。複数フィールド更新で競合の可能性がある場合は `runTransaction` を優先。
- マルチデバイス競合を常に意識。必要に応じてトランザクション・サーバータイムスタンプ・冪等なデータ構造で対策。
- Firestore アクセスは `lib/firestore.ts` に集約。コンポーネントから直接 Firestore を叩かない。
- 型定義は `types/index.ts` に追加・更新し、`any` 禁止。既存型との互換性を維持。
- 静的エクスポート前提で実装。サーバー常駐前提の機能は禁止（代替案を提示）。画像最適化は `unoptimized: true`。

## 6. コード生成スタイル（UI・実装・TypeScript）
- React/Next.js: Server Components をデフォルト。ブラウザ API や局所状態が必須な箇所のみ Client Component。ロジックはカスタムフックに分離し、コンポーネントは単一責任・小さめに。
- TypeScript: 型駆動で実装。nullable / union を明示。ユーティリティ型を活用し、`any` 不使用。関数は副作用を最小化。
- Styling: Tailwind CSS クラスをインラインで付与。モバイルファーストでレスポンシブ、タッチターゲットは 44px 以上。テーマは既存の RoastPlus トーンを保ち、過剰な装飾を避ける。
- Firebase: 例外は握り潰さずログ＋ユーザー通知方針を併記。書き込みキュー/デバウンス/セマフォが必要な場合は理由を説明して実装。
- テキスト/コメント: UI/設計意図は短めコメントまたは docstring で「なぜ」を説明（「何を」はコードで表現）。
- 出力形式: コードは省略せず必要部分を完全提示する。before/after かファイル全文を示し、「省略します」「一部のみ記載」は禁止。

## 7. 小さなステップで安全に変更
- 1 回の変更で触るファイルは最小限に限定。大規模改修はチャンクに分割し、段階ごとに合意を取る。
- 既存仕様を壊す可能性がある場合は事前に明示し、最小修正案を併せて用意。
- 変更前後で挙動が等価かを確認する簡易チェックを必ず提示。自動テストが無い場合は手動手順を箇条書きで示す。
- Firestore スキーマ変更やデータ破壊的操作は、影響とマイグレーション方針を説明してから実施。

## 8. 説明スタイル
- 言語は日本語、箇条書き中心で短く明快に。
- 実装前: 目的・現状・リスク・方針を先に提示。
- 実装後: 変更概要・解消したリスク・未確認事項・確認手順・次の一手を報告。ファイルパスはインラインコードで示す。
- 不明点や誤解の可能性がある場合は必ず依頼者に確認し、リスクを説明してから進める。

## 9. 禁止事項
- ローカル時間依存の判定・表示・書き込み
- 楽観的更新（Firestore 更新前に UI だけ進めること）
- setTimeout などによる段階的・後書き込みの Firestore 永続化
- 複数フィールドを別々かつ非トランザクションで書くこと
- Firestore スキーマ破壊や既存データ消去を、影響説明なしで提案・実施すること