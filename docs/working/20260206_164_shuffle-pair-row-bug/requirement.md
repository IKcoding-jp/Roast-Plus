# 要件定義

**Issue**: #164
**作成日**: 2026-02-06
**ラベル**: bug

## ユーザーストーリー
ユーザー「担当票をシャッフルしたのに、また同じ行に同じメンバーがいる。しかもペアも前回と同じ。毎回違うペア、違う行にしてほしい」
アプリ「シャッフルのたびに前回と異なる行・異なるペアで割り当てを行い、公平な結果を提供する」

## 現状の問題

### バグ1: ペア回避条件の不具合（shuffle.ts:243）
- `selectedMembers.length < neededCount - 1` の条件により、neededCount=2の行では2人目選択時にペアペナルティが無視される
- 小規模行（2〜3人枠）でペア連続回避が実質機能していない

### バグ2: 行の連続回避が不十分
- 候補が少ない行が優先処理されるため、後の行で「残り物」からしか選べない
- 行の連続ペナルティ（100,000）は高いが、ペナルティスキップ条件（50,000閾値）との組み合わせで無効化される場合がある

### バグ3: 完璧判定の基準が不適切
- `loopScore < eligibleMembers.length * 10` は、ランダム要素の加算（0〜1）がメンバー数分累積するため、実質的に「ペナルティ0のみ完璧」を意味するが、ランダムノイズで偶発的に通過するケースがある

## 要件一覧

### 必須要件
- [ ] シャッフル実行ごとに、前回と**異なる行（担当）**にメンバーが割り当てられる
- [ ] シャッフル実行ごとに、前回と**異なるペア**（同じ行のメンバー組み合わせ）になる
- [ ] 上記が少なくとも直近1回分の履歴に対して保証される
- [ ] 可能な限り2回前の履歴も考慮される（メンバー数が少ない場合は例外許容）
- [ ] 既存のペア除外設定（PairExclusion）が引き続き正常動作する

### オプション要件
- [ ] 3回以上前の履歴も可能な範囲で考慮する
- [ ] シャッフルの公平性（特定メンバーが特定行に偏らない）を向上

## 受け入れ基準
- [ ] Chrome DevToolsでシャッフルを複数回実行し、前回と同じ行にメンバーが配置されないことを確認
- [ ] Chrome DevToolsでシャッフルを複数回実行し、前回と同じペアが出現しないことを確認
- [ ] ペア除外設定が機能することを確認
- [ ] メンバー数が少ない極端なケースでもエラーが発生しないことを確認
- [ ] 既存テストが通過すること（テストがある場合）

## 制約事項
- FEATURES.md: 「シャッフルロジックの根本的変更（バグ修正のみ）」→ バグ修正の範囲で改善する
- calculateAssignment関数のインターフェース（引数・戻り値）は変更しない
- 履歴の取得数（2件）は変更しない（Firestoreの読み込み量を増やさない）
